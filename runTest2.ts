import { alignBeats } from "./nodes/TextAligner/aligner/alignment";
import type { AlignmentOptions, StoryBeatCandidate } from "./nodes/TextAligner/aligner/types";

const story = ` It starts quietly. No one notices at first. You're seven years old, staring into the eyes of a parent who is falling apart. Maybe it's addiction. Maybe it's anger. Maybe it's just the hollow silence of someone too broken to show up. And without words, something ancient clicks in your small mind. If I don't hold everything together, no one will. This is how a child disappears. Not physically, but psychologically. They smile more. They cry less. They learn to read the room before they speak. They become the emotional thermostat of the household. They become small adults long before their minds are ready. And the world praises them for it. You're so mature. You're so responsible. You're so strong. But no one ever stops to ask. At what cost? This is the invisible grief of those who grew up too fast. And today we're going deep inside the psychology of that child. Because the effects don't vanish with age. They shape you. They follow you into relationships, careers, your sense of worth. And if you don't understand what happened, you'll spend your adult life repeating the survival patterns that once saved you, but are now slowly killing you. Let's start with what's really happening, developmentally. When children are forced to emotionally support adults instead of the other way around, psychologists call this parentification. It's when a child becomes the caregiver, the peacekeeper, the therapist, the protector. This isn't just unhealthy, it rewires the brain. Because when a child is consistently put in charge of emotional regulation, either their own or others, it creates something called hypervigilance. You're always scanning for danger. You walk on eggshells. You learn that love is a transaction. You give peace, and maybe they'll give you safety. You learn that your needs are dangerous, and theirs are urgent. So you disappear, not physically, but emotionally. And in your place grows a version of you that performs well. You become the good child, the quiet achiever, the therapist friend, the one who never asks for anything. And you wear that identity so convincingly that even you forget it's a mask. But deep down, something hurts. Something aches because the inner child you buried didn't die. They're still in there, screaming silently, why didn't anyone protect me? As you grow older, the symptoms become more complex. You might become hyper-independent. You refuse help, push people away, or never feel truly safe in love. You might feel numb during happy moments, because joy feels unfamiliar, unearned, even dangerous. You might struggle to rest because productivity is the only way you've ever felt worthy. And worst of all, you might not even realize you're still stuck in survival mode. Because when dysfunction is normalized early, your nervous system accepts chaos as baseline. Stillness feels wrong. Peace feels suspicious. Love feels like a debt you'll have to repay. This is the psychology of a child forced to grow up too fast. It's not just sadness. It's a complex trauma that reshapes how you view the world. And more importantly, yourself. Now, you may ask, why would any child willingly take on that role? Because children will do anything for attachment, even abandon themselves. The choice is never conscious. It's biological. In the absence of safety, the child sacrifices authenticity for belonging. That's not weakness, that's intelligence, that's instinct. But the tragedy is this. What saved you then, imprisons you now. So many of us are walking around as high-functioning adults, with deeply neglected inner children pulling the strings. We overachieve to earn love. We stay silent to avoid abandonment. We take care of everyone, but secretly wish someone would just ask if we're okay. And that fantasy? That someone will notice you're not as strong as you pretend to be. That maybe, just maybe, you'll finally get to fall apart and be held? That is the unmet need, not of your adult self. But of the child who never got to be a child. The first step to healing isn't fixing. It's witnessing. Because until you validate what happened, you'll keep gaslighting yourself with thoughts like, it wasn't that bad. Other people had it worse. I turned out fine. But fine is a mask too. And deep down, you know it. So what happens to that child? When they grow up, they become adults who never feel safe. Even in calm rooms. They become lovers who can't trust softness. They become givers who can't receive. They become the kind of people who apologize for crying, flinch at compliments, and confuse exhaustion with success. This is the cost of growing up too fast. Because if your childhood trained you to be strong at the expense of being soft, to be quiet instead of honest, to fix others while ignoring your own fractures, then what kind of adulthood do you inherit? You inherit a life where you're always holding your breath, waiting. For someone to give you permission to finally fall apart. But here's the truth. No one's coming to rescue the child you buried. You are the one who must go back and hold their hand. You are the one who must say what no one else ever said. You didn't deserve that. You were just a child. You get to rest now. This is the beginning of shadow work. Not fixing, not performing, not bypassing the pain with fake positivity, but turning toward the abandoned parts of yourself and saying, I see you now. I hear you now. And I'm not leaving. That is the reparenting process. And it's brutal because it asks you to feel the grief you never had time to feel. It asks you to sit with the rage, the sorrow, the unmet needs. To weep for the birthdays where no one showed up. To mourn the innocence you lost while protecting people who should have protected you. But that grief, it's not weakness. It's proof that you're healing. Because what was once frozen is finally falling. Now let's talk about how this survival pattern shows up in adulthood. Subtly, tragically, and often invisibly. You might become a therapist in all your friendships, but never let anyone truly see you. You might be praised for your independence when deep down you're terrified of being a burden. You might be in relationships where you overfunction, always fixing, managing, over-explaining, and wondering why you feel resentful. You might struggle with boundaries because saying no still feels like betrayal. These are not personality traits. They are coping strategies, learned, conditioned, and, the good news, un-learnable. But only when you stop idolizing your strength and start honoring your wounds, one of the most powerful things you can do is ask your inner child, what did I need back then that I never got? You may hear answers like, I needed someone to tell me it wasn't my fault. I needed someone to ask how I was doing. I needed to play, rest, laugh, without fear. And slowly, very slowly, you begin to give those things to yourself. Not to fix your past, but to stop reliving it. This is how you stop seeking parents and your partners. This is how you stop mistaking anxiety for intuition. This is how you stop running from the child you were and the self you're becoming. Carl Jung once said, There is no coming to consciousness without pain. People will do anything, no matter how absurd, to avoid facing their own soul. But shadow work demands that we face it. All of it. The neglected, the ashamed, the scared, the angry. Because healing isn't about becoming someone new, it's about remembering who you were before the world told you who to be. So if you're someone who grew up too fast, know this, your maturity was never the problem. The problem was that you had no choice, but now you do. You can choose softness, you can choose to rest, you can choose to stop managing everyone else's emotions and start honoring your own. And no, it won't happen overnight. There will be days you feel like a child again. Good, that's the point. Let that child come home, let them cry, let them play, let them finally be seen. Because you're not broken, you're becoming whole. And maybe for the first time, you're finally growing up the right way. Not through pressure, not through fear, but through truth. You never had a childhood. But you still have a future, and this time, you get to write it. Lotus always you. What love.`;

const beatCandidates: StoryBeatCandidate[] = [
    {
        "title": "The Invisible Disappearance & Parentification",
        "script": "It starts quietly. No one notices at first. You're seven years old, staring into the eyes of a parent who is falling apart. Maybe it's addiction. Maybe it's anger. Maybe it's just the hollow silence of someone too broken to show up. And without words, something ancient clicks in your small mind. If I don't hold everything together, no one will. This is how a child disappears. Not physically, but psychologically. They smile more. They cry less. They learn to read the room before they speak. They become the emotional thermostat of the household. They become small adults long before their minds are ready. And the world praises them for it. You're so mature. You're so responsible. You're so strong. But no one ever stops to ask. At what cost? This is the invisible grief of those who grew up too fast. And today we're going deep inside the psychology of that child. Because the effects don't vanish with age. They shape you. They follow you into relationships, careers, your sense of worth. And if you don't understand what happened, you'll spend your adult life repeating the survival patterns that once saved you, but are now slowly killing you. Let's start with what's really happening, developmentally. When children are forced to emotionally support adults instead of the other way around, psychologists call this parentification. It's when a child becomes the caregiver, the peacekeeper, the therapist, the protector. This isn't just unhealthy, it rewires the brain. Because when a child is consistently put in charge of emotional regulation, either their own or others, it creates something called hypervigilance. You're always scanning for danger. You walk on eggshells. You learn that love is a transaction. You give peace, and maybe they'll give you safety. You learn that your needs are dangerous, and theirs are urgent. So you disappear, not physically, but emotionally. And in your place grows a version of you that performs well. You become the good child, the quiet achiever, the therapist friend, the one who never asks for anything. And you wear that identity so convincingly that even you forget it's a mask. But deep down, something hurts. Something aches because the inner child you buried didn't die. They're still in there, screaming silently, why didn't anyone protect me?"
    },
    {
        "title": "The Enduring Cost in Adulthood",
        "script": "As you grow older, the symptoms become more complex. You might become hyper-independent. You refuse help, push people away, or never feel truly safe in love. You might feel numb during happy moments, because joy feels unfamiliar, unearned, even dangerous. You might struggle to rest because productivity is the only way you've ever felt worthy. And worst of all, you might not even realize you're still stuck in survival mode. Because when dysfunction is normalized early, your nervous system accepts chaos as baseline. Stillness feels wrong. Peace feels suspicious. Love feels like a debt you'll have to repay. This is the psychology of a child forced to grow up too fast. It's not just sadness. It's a complex trauma that reshapes how you view the world. And more importantly, yourself. Now, you may ask, why would any child willingly take on that role? Because children will do anything for attachment, even abandon themselves. The choice is never conscious. It's biological. In the absence of safety, the child sacrifices authenticity for belonging. That's not weakness, that's intelligence, that's instinct. But the tragedy is this. What saved you then, imprisons you now. So many of us are walking around as high-functioning adults, with deeply neglected inner children pulling the strings. We overachieve to earn love. We stay silent to avoid abandonment. We take care of everyone, but secretly wish someone would just ask if we're okay. And that fantasy? That someone will notice you're not as strong as you pretend to be. That maybe, just maybe, you'll finally get to fall apart and be held? That is the unmet need, not of your adult self. But of the child who never got to be a child."
    },
    {
        "title": "Witnessing & Reparenting for Healing",
        "script": "The first step to healing isn't fixing. It's witnessing. Because until you validate what happened, you'll keep gaslighting yourself with thoughts like, it wasn't that bad. Other people had it worse. I turned out fine. But fine is a mask too. And deep down, you know it. So what happens to that child? When they grow up, they become adults who never feel safe. Even in calm rooms. They become lovers who can't trust softness. They become givers who can't receive. They become the kind of people who apologize for crying, flinch at compliments, and confuse exhaustion with success. This is the cost of growing up too fast. Because if your childhood trained you to be strong at the expense of being soft, to be quiet instead of honest, to fix others while ignoring your own fractures, then what kind of adulthood do you inherit? You inherit a life where you're always holding your breath, waiting. For someone to give you permission to finally fall apart. But here's the truth. No one's coming to rescue the child you buried. You are the one who must go back and hold their hand. You are the one who must say what no one else ever said. You didn't deserve that. You were just a child. You get to rest now. This is the beginning of shadow work. Not fixing, not performing, not bypassing the pain with fake positivity, but turning toward the abandoned parts of yourself and saying, I see you now. I hear you now. And I'm not leaving. That is the reparenting process. And it's brutal because it asks you to feel the grief you never had time to feel. It asks you to sit with the rage, the sorrow, the unmet needs. To weep for the birthdays where no one showed up. To mourn the innocence you lost while protecting people who should have protected you. But that grief, it's not weakness. It's proof that you're healing. Because what was once frozen is finally falling."
    },
    {
        "title": "Embracing Wholeness and a New Future",
        "script": "Now let's talk about how this survival pattern shows up in adulthood. Subtly, tragically, and often invisibly. You might become a therapist in all your friendships, but never let anyone truly see you. You might be praised for your independence when deep down you're terrified of being a burden. You might be in relationships where you overfunction, always fixing, managing, over-explaining, and wondering why you feel resentful. You might struggle with boundaries because saying no still feels like betrayal. These are not personality traits. They are coping strategies, learned, conditioned, and, the good news, un-learnable. But only when you stop idolizing your strength and start honoring your wounds, one of the most powerful things you can do is ask your inner child, what did I need back then that I never got? You may hear answers like, I needed someone to tell me it wasn't my fault. I needed someone to ask how I was doing. I needed to play, rest, laugh, without fear. And slowly, very slowly, you begin to give those things to yourself. Not to fix your past, but to stop reliving it. This is how you stop seeking parents and your partners. This is how you stop mistaking anxiety for intuition. This is how you stop running from the child you were and the self you're becoming. Carl Jung once said, There is no coming to consciousness without pain. People will do anything, no matter how absurd, to avoid facing their own soul. But shadow work demands that we face it. All of it. The neglected, the ashamed, the scared, the angry. Because healing isn't about becoming someone new, it's about remembering who you were before the world told you who to be. So if you're someone who grew up too fast, know this, your maturity was never the problem. The problem was that you had no choice, but now you do. You can choose softness, you can choose to rest, you can choose to stop managing everyone else's emotions and start honoring your own. And no, it won't happen overnight. There will be days you feel like a child again. Good, that's the point. Let that child come home, let them cry, let them play, let them finally be seen. Because you're not broken, you're becoming whole. And maybe for the first time, you're finally growing up the right way. Not through pressure, not through fear, but through truth. You never had a childhood. But you still have a future, and this time, you get to write it. Lotus always you. What love."
    }
];

const options: AlignmentOptions = {
    fuzzyThreshold: 0.55,
    maxExpansion: 160,
    maxContraction: 0.45,
    boundaryMode: "word"
};

console.log("=== Alignment Configuration ===");
console.log(`fuzzyThreshold: ${options.fuzzyThreshold}`);
console.log(`maxExpansion: ${options.maxExpansion} characters`);
console.log(`maxContraction: ${options.maxContraction} (${Math.round((options.maxContraction ?? 0.45) * 100)}%)`);
console.log();

const results = alignBeats(story, beatCandidates, options);

console.log("=== Alignment Results ===");
results.forEach((beat, index) => {
  const matchType = beat.exact ? "EXACT MATCH" : "FUZZY MATCH";
  const thresholdMet = beat.similarity >= (options.fuzzyThreshold ?? 0.55) ? "✓" : "✗ (last beat exception)";
  
  console.log(`\nBeat ${index + 1}: ${beat.title || "Untitled"}`);
  console.log(`Match Type: ${matchType}`);
  console.log(`Similarity: ${beat.similarity.toFixed(3)} / ${options.fuzzyThreshold} ${thresholdMet}`);
  console.log(`Position: [${beat.start}, ${beat.end}) (${beat.end - beat.start} chars)`);
  console.log("\nOriginal script:");
  console.log(`  "${beat.script}"`);
  console.log("\nMatched text:");
  console.log(`  "${beat.matchedText}"`);
});

const reconstructed = results.map((beat) => beat.matchedText).join("");
console.log("\n=== Summary ===");
console.log(`Story fully reconstructed: ${reconstructed === story ? "✓" : "✗"}`);
console.log(`Total beats: ${results.length}`);
console.log(`Exact matches: ${results.filter(b => b.exact).length}`);
console.log(`Fuzzy matches: ${results.filter(b => !b.exact).length}`);
console.log(`Average similarity: ${(results.reduce((sum, b) => sum + b.similarity, 0) / results.length).toFixed(3)}`);